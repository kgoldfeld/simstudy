<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clustered Data • simstudy</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Clustered Data">
<meta property="og:description" content="simstudy">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">simstudy</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.6.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/simstudy.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/clustered.html">Clustered Data</a>
    </li>
    <li>
      <a href="../articles/corelationmat.html">Correlation Matrices</a>
    </li>
    <li>
      <a href="../articles/correlated.html">Correlated Data</a>
    </li>
    <li>
      <a href="../articles/double_dot_extension.html">Dynamic Data Definition</a>
    </li>
    <li>
      <a href="../articles/longitudinal.html">Longitudinal Data</a>
    </li>
    <li>
      <a href="../articles/missing.html">Missing Data</a>
    </li>
    <li>
      <a href="../articles/ordinal.html">Ordinal Categorical Data</a>
    </li>
    <li>
      <a href="../articles/spline.html">Spline Data</a>
    </li>
    <li>
      <a href="../articles/survival.html">Survival Data</a>
    </li>
    <li>
      <a href="../articles/treat_and_exposure.html">Treatment and Exposure</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kgoldfeld/simstudy/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Clustered Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/kgoldfeld/simstudy/blob/HEAD/vignettes/clustered.Rmd" class="external-link"><code>vignettes/clustered.Rmd</code></a></small>
      <div class="hidden name"><code>clustered.Rmd</code></div>

    </div>

    
    
<p>The function <code>genCluster</code> generates multilevel or
clustered data based on a previously generated data set that is one
“level” up from the clustered data. For example, if there is a data set
that contains the school level (considered here to be level 2),
classrooms (level 1) can be generated. And then, students (now level 1)
can be generated within classrooms (now level 2)</p>
<p>In the example here, we do in fact generate school-, class-, and
student-level data. There are eight schools, four of which are
randomized to receive an intervention. The number of classes per school
varies, as does the number of students per class. (It is straightforward
to generate fully balanced data by using constant values.) The outcome
of interest is a test score, which is influenced by gender and the
intervention. In addition, test scores vary by schools, and by
classrooms, so the simulation provides <em>random effects</em> at each
of these levels.</p>
<p>We start by defining the school level data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gen.school</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/defData.html">defData</a></span><span class="op">(</span>varname <span class="op">=</span> <span class="st">"s0"</span>, dist <span class="op">=</span> <span class="st">"normal"</span>, formula <span class="op">=</span> <span class="fl">0</span>, variance <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    id <span class="op">=</span> <span class="st">"idSchool"</span><span class="op">)</span></span>
<span><span class="va">gen.school</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/defData.html">defData</a></span><span class="op">(</span><span class="va">gen.school</span>, varname <span class="op">=</span> <span class="st">"nClasses"</span>, dist <span class="op">=</span> <span class="st">"noZeroPoisson"</span>, formula <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">282721</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dtSchool</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/genData.html">genData</a></span><span class="op">(</span><span class="fl">8</span>, <span class="va">gen.school</span><span class="op">)</span></span>
<span><span class="va">dtSchool</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trtAssign.html">trtAssign</a></span><span class="op">(</span><span class="va">dtSchool</span>, n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dtSchool</span></span></code></pre></div>
<pre><code><span><span class="co">##    idSchool         s0 nClasses trtGrp</span></span>
<span><span class="co">## 1:        1  0.9732297        3      1</span></span>
<span><span class="co">## 2:        2  3.5741932        4      1</span></span>
<span><span class="co">## 3:        3  0.1121028        3      0</span></span>
<span><span class="co">## 4:        4  0.5147236        4      1</span></span>
<span><span class="co">## 5:        5  0.4594058        1      0</span></span>
<span><span class="co">## 6:        6 -0.1287554        4      0</span></span>
<span><span class="co">## 7:        7  2.4400170        2      1</span></span>
<span><span class="co">## 8:        8 -1.2496060        1      0</span></span></code></pre>
<p>The classroom level data are generated with a call to
<code>genCluster</code>, and then school level data is added by a call
to <code>addColumns</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gen.class</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/defDataAdd.html">defDataAdd</a></span><span class="op">(</span>varname <span class="op">=</span> <span class="st">"c0"</span>, dist <span class="op">=</span> <span class="st">"normal"</span>, formula <span class="op">=</span> <span class="fl">0</span>, variance <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">gen.class</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/defDataAdd.html">defDataAdd</a></span><span class="op">(</span><span class="va">gen.class</span>, varname <span class="op">=</span> <span class="st">"nStudents"</span>, dist <span class="op">=</span> <span class="st">"noZeroPoisson"</span>,</span>
<span>    formula <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dtClass</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/genCluster.html">genCluster</a></span><span class="op">(</span><span class="va">dtSchool</span>, <span class="st">"idSchool"</span>, numIndsVar <span class="op">=</span> <span class="st">"nClasses"</span>, level1ID <span class="op">=</span> <span class="st">"idClass"</span><span class="op">)</span></span>
<span><span class="va">dtClass</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addColumns.html">addColumns</a></span><span class="op">(</span><span class="va">gen.class</span>, <span class="va">dtClass</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dtClass</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     idSchool        s0 nClasses trtGrp idClass          c0 nStudents</span></span>
<span><span class="co">##  1:        1 0.9732297        3      1       1  1.62726560        16</span></span>
<span><span class="co">##  2:        1 0.9732297        3      1       2 -0.69640102        16</span></span>
<span><span class="co">##  3:        1 0.9732297        3      1       3  1.53921338        13</span></span>
<span><span class="co">##  4:        2 3.5741932        4      1       4 -1.58765603        30</span></span>
<span><span class="co">##  5:        2 3.5741932        4      1       5 -2.35483046        26</span></span>
<span><span class="co">##  6:        2 3.5741932        4      1       6  0.45956895        20</span></span>
<span><span class="co">##  7:        2 3.5741932        4      1       7 -0.88401500        26</span></span>
<span><span class="co">##  8:        3 0.1121028        3      0       8 -1.46100446        19</span></span>
<span><span class="co">##  9:        3 0.1121028        3      0       9  0.07024057        19</span></span>
<span><span class="co">## 10:        3 0.1121028        3      0      10  1.09465368        21</span></span></code></pre>
<p>Finally, the student level data are added using the same process:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gen.student</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/defDataAdd.html">defDataAdd</a></span><span class="op">(</span>varname <span class="op">=</span> <span class="st">"Male"</span>, dist <span class="op">=</span> <span class="st">"binary"</span>,</span>
<span>    formula <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">gen.student</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/defDataAdd.html">defDataAdd</a></span><span class="op">(</span><span class="va">gen.student</span>, varname <span class="op">=</span> <span class="st">"age"</span>, dist <span class="op">=</span> <span class="st">"uniform"</span>,</span>
<span>    formula <span class="op">=</span> <span class="st">"9.5; 10.5"</span><span class="op">)</span></span>
<span><span class="va">gen.student</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/defDataAdd.html">defDataAdd</a></span><span class="op">(</span><span class="va">gen.student</span>, varname <span class="op">=</span> <span class="st">"test"</span>, dist <span class="op">=</span> <span class="st">"normal"</span>,</span>
<span>    formula <span class="op">=</span> <span class="st">"50 - 5*Male + s0 + c0 + 8 * trtGrp"</span>, variance <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">dtStudent</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/genCluster.html">genCluster</a></span><span class="op">(</span><span class="va">dtClass</span>, cLevelVar <span class="op">=</span> <span class="st">"idClass"</span>, numIndsVar <span class="op">=</span> <span class="st">"nStudents"</span>,</span>
<span>    level1ID <span class="op">=</span> <span class="st">"idChild"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dtStudent</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addColumns.html">addColumns</a></span><span class="op">(</span><span class="va">gen.student</span>, <span class="va">dtStudent</span><span class="op">)</span></span></code></pre></div>
<p>This is what the clustered data look like. Each classroom is
represented by a box, and each school is represented by a color. The
intervention group is highlighted by dark outlines:</p>
<pre><code><span><span class="co">## Warning: The `guide` argument in `scale_*()` cannot be `FALSE`. This was deprecated in</span></span>
<span><span class="co">## ggplot2 3.3.4.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Please use "none" instead.</span></span>
<span><span class="co">## <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">## <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">## <span style="color: #555555;">generated.</span></span></span></code></pre>
<p><img src="clustered_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<div class="section level3">
<h3 id="setting-cluster-sizes">Setting cluster sizes<a class="anchor" aria-label="anchor" href="#setting-cluster-sizes"></a>
</h3>
<p>It could be helpful to relax the assumption of exactly balanced
cluster size when estimating statistical power using simulation. There
is a “distribution” called <em>clusterSize</em> that facilitates these
stochastic cluster sizes. As part of data definitions, you can specify
the overall sample size <em>N</em> in the formula argument, and a
dispersion parameter (in the variance field) Indicating a dispersion of
0 (the default) implies exact balance, and larger values of dispersion
imply more variability in the cluster sizes.</p>
<p>Here are two examples with exact or close to exact balance:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/defData.html">defData</a></span><span class="op">(</span>varname <span class="op">=</span> <span class="st">"clustSize"</span>, formula <span class="op">=</span> <span class="fl">120</span>, dist <span class="op">=</span> <span class="st">"clusterSize"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/genData.html">genData</a></span><span class="op">(</span><span class="fl">8</span>, <span class="va">d1</span>, id <span class="op">=</span> <span class="st">"site"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    site clustSize</span></span>
<span><span class="co">## 1:    1        15</span></span>
<span><span class="co">## 2:    2        15</span></span>
<span><span class="co">## 3:    3        15</span></span>
<span><span class="co">## 4:    4        15</span></span>
<span><span class="co">## 5:    5        15</span></span>
<span><span class="co">## 6:    6        15</span></span>
<span><span class="co">## 7:    7        15</span></span>
<span><span class="co">## 8:    8        15</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/genData.html">genData</a></span><span class="op">(</span><span class="fl">7</span>, <span class="va">d1</span>, id <span class="op">=</span> <span class="st">"site"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    site clustSize</span></span>
<span><span class="co">## 1:    1        17</span></span>
<span><span class="co">## 2:    2        17</span></span>
<span><span class="co">## 3:    3        17</span></span>
<span><span class="co">## 4:    4        17</span></span>
<span><span class="co">## 5:    5        17</span></span>
<span><span class="co">## 6:    6        18</span></span>
<span><span class="co">## 7:    7        17</span></span></code></pre>
<p>This is a second example with variability across sites:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/defData.html">defData</a></span><span class="op">(</span>varname <span class="op">=</span> <span class="st">"clustSize"</span>, formula <span class="op">=</span> <span class="fl">120</span>, </span>
<span>  variance <span class="op">=</span> <span class="fl">.1</span>, dist <span class="op">=</span> <span class="st">"clusterSize"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/genData.html">genData</a></span><span class="op">(</span><span class="fl">8</span>, <span class="va">d1</span>, id <span class="op">=</span> <span class="st">"site"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    site clustSize</span></span>
<span><span class="co">## 1:    1        22</span></span>
<span><span class="co">## 2:    2        15</span></span>
<span><span class="co">## 3:    3        15</span></span>
<span><span class="co">## 4:    4        11</span></span>
<span><span class="co">## 5:    5        11</span></span>
<span><span class="co">## 6:    6        11</span></span>
<span><span class="co">## 7:    7        17</span></span>
<span><span class="co">## 8:    8        18</span></span></code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://www.rdatagen.net/" class="external-link">Keith Goldfeld</a>, Jacob Wujciak-Jens.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
